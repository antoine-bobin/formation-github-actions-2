name: "Output workflow"
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  output:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: ["develop"]
    steps:
#      - name: "Output github"
#        run: echo "${{ toJSON(github) }}"

      - name: "Checkout code from develop"
        uses: actions/checkout@v4 # v4.1.0
        with:
          ref: develop
#          token: ${{ secrets.CI_KEY }}
          fetch-depth: 0

      - name: "Merge master into develop"
        id: merge
        run: |
          git config --global user.name 'allotomation' && \
          git config --global user.email 'serviceaccount.allotomation@allopneus.com' && \
          git merge origin/main --no-ff && \
          giiiiiit push origin develop >> $GITHUB_OUTPUT

#      - name: "Notify failure on Teams channel"
#        if: failure()
#        # JSON format: https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/connectors-using
#        run: |
#          echo "Notify failure on Teams channel"
#          cat << EOF > message.json
#          {
#            "@type":"MessageCard",
#            "@context":"https://schema.org/extensions",
#            "summary":"Fail to merge master into ${{ matrix.branch }} for hevea-stations-api",
#            "title": "[hevea-stations-api] Fail to merge branches : master → ${{ matrix.branch }}",
#            "themeColor":"ff6600",
#            "potentialAction":[
#              {
#                "@type":"OpenUri",
#                "name":"Voir le lien",
#                "targets":[
#                  {
#                    "os":"default",
#                    "uri":"https://rick.roll"
#                  }
#                ]
#              }
#             ]
#          }
#          EOF
..
      - name: "Notify merge failure on Teams channel"
        if: failure()
        # JSON format: https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/connectors-using
        run: |
          cat << EOF > message.json
          {
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "themeColor": "0076D7",
            "summary": "Test Message:  in progress...",
            "sections": [{
                "name": "Project:",
                "value": "hevea-stations-api"
              }, {
              "activityTitle": "[CI/CD] Fail to merge branches",
              "activitySubtitle": "An error occurred when merging master branch.",
              "facts": [{
                "name": "Branches:",
                "value": "master → ${{ matrix.branch }}"
              }, {
                "name": "Error:",
                "value": "${{ steps.merge.outputs.* }}"
              }, {
                "name": "Status:",
                "value": "Failed"
              }]
            }]
          }
          EOF
          curl -X POST https://allopneus.webhook.office.com/webhookb2/e4228484-8970-4176-95a0-719bc0f259d8@ac205d14-f9ff-4d7a-8129-aa50d3988c68/IncomingWebhook/b100761b92c841caafaec419b2d9b52a/0f9dd978-347f-4955-8e79-48bd2ae1c980 --header 'Content-Type: application/json' -d @message.json
